---
- name: stop cloudera-scm-agent
  systemd:
    name: {{ svc_cm_agent }}
    state: stopped

- name: uninstall cloudera-manager-server
  yum: 
    name: {{ pkg_cm_agent }}
    state: absent

- name: yum clean
  command: yum clean all

# do 1-4 on cm web 
# followings are 5~7
- name: more clean
  command: {{ item }}
  with_items:
    # on cloudera manager server host
    - systemctl stop cloudera-scm-server
    - yum remove cloudera-manager-server -y

    # on all cloudera manager agent hosts
    - systemctl stop cloudera-scm-agent
    - yum remove 'cloudera-manager-*' -y
    - yum clean all  

    # Remove Cloudera Manager Data
    - umount cm_processes
    - rm -Rf /usr/share/cmf /var/lib/cloudera* /var/cache/yum/cloudera* /var/log/cloudera* /var/run/cloudera*

    # Remove the Cloudera Manager Lock File
    # On all Agent hosts, run this command to remove the Cloudera Manager lock file:
    - rm /tmp/.scm_prepare_node.lock

    # Remove User Data
    # This step permanently removes all user data. To preserve the data, copy it to another cluster using the distcp command before starting the uninstall process. On all Agent hosts, run the following commands:
    - rm -Rf /var/lib/flume-ng /var/lib/hadoop* /var/lib/hue /var/lib/navigator /var/lib/oozie /var/lib/solr /var/lib/sqoop* /var/lib/zookeeper

    # Run the following command on each data drive on all Agent hosts (adjust the paths for the data drives on each host):
    - rm -Rf data_drive_path/dfs data_drive_path/mapred data_drive_path/yarn

- name: notify - echo uptime
  notify:
  - echo uptime
